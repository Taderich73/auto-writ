[tox]
envlist =
    py3
    format-check
    format
    lint
    mypy
    bandit
    coverage
minversion = 4.0
isolated_build = true

[testenv]
description = Run unit tests with pytest
skip_install = false
deps =
    pytest>=7.0
    pytest-cov>=4.0
    pytest-xdist>=3.0
commands =
    pytest {posargs:tests}

[testenv:format]
description = Format code with ruff and black
skip_install = true
deps =
    black>=24.0
    ruff>=0.1.0
commands =
    ruff check --select I --fix src/writ
    black src/writ tests

[testenv:format-check]
description = Check code formatting without making changes
skip_install = true
deps =
    black>=24.0
    ruff>=0.1.0
commands =
    ruff check --select I src/writ tests
    black --check --diff src/writ tests

[testenv:lint]
description = Run linting checks with ruff and pylint
skip_install = false
deps =
    ruff>=0.1.0
    pylint>=3.0
commands =
    ruff check src/writ tests
    pylint src/writ --fail-under=9.0

[testenv:mypy]
description = Run static type checking with mypy
skip_install = false
deps =
    mypy>=1.8
    types-PyYAML>=6.0
commands =
    mypy src/writ

[testenv:bandit]
description = Run security linting with bandit
skip_install = true
deps =
    bandit[toml]>=1.7
commands =
    bandit -r src/writ -c pyproject.toml

[testenv:coverage]
description = Run tests with coverage reporting
skip_install = false
deps =
    pytest>=7.0
    pytest-cov>=4.0
commands =
    pytest --cov=writ --cov-report=term-missing --cov-report=html --cov-report=xml --cov-fail-under=80 {posargs:tests}

[testenv:all]
description = Run all quality checks (format-check, lint, mypy, bandit)
skip_install = false
deps =
    {[testenv:format-check]deps}
    {[testenv:lint]deps}
    {[testenv:mypy]deps}
    {[testenv:bandit]deps}
commands =
    {[testenv:format-check]commands}
    {[testenv:lint]commands}
    {[testenv:mypy]commands}
    {[testenv:bandit]commands}

[testenv:clean]
description = Clean up temporary files and build artifacts
skip_install = true
deps =
allowlist_externals =
    rm
    find
commands =
    rm -rf .tox
    rm -rf build dist *.egg-info
    rm -rf .pytest_cache .mypy_cache .ruff_cache
    rm -rf htmlcov .coverage coverage.xml
    find . -type d -name __pycache__ -exec rm -rf {} +
    find . -type f -name "*.pyc" -delete
    find . -type f -name "*.pyo" -delete

[testenv:dev]
description = Setup development environment with all tools
skip_install = false
deps =
    black>=24.0
    ruff>=0.1.0
    mypy>=1.8
    types-PyYAML>=6.0
    pylint>=3.0
    bandit[toml]>=1.7
    pytest>=7.0
    pytest-cov>=4.0
    pytest-xdist>=3.0
commands =
    python -c "print('writ development environment ready!')"
    python -c "print('Run: tox -e format, tox -e lint, tox -e mypy, tox -e coverage, etc.')"

[testenv:watch]
description = Run tests in watch mode for development
skip_install = false
deps =
    pytest>=7.0
    pytest-cov>=4.0
    pytest-watch>=4.0
commands =
    pytest-watch -- {posargs:tests}

[gh-actions]
# GitHub Actions integration mapping
python =
    3.12: py312
    3.13: py313 format-check, lint, mypy, bandit, coverage
    3.14: py314
